# 脚本工具

## 文章同步脚本

`sync-posts.js` - 同步 markdown 文章到数据库

### 功能

- ✅ 全量同步所有文章
- ✅ 同步单个指定文章
- ✅ 自动创建或更新
- ✅ 支持目录和文件两种格式
- ✅ 验证必需字段

### 使用方法

#### 1. 全量同步所有文章

```bash
# 使用 npm script（推荐）
pnpm sync:all

# 或直接运行脚本
node scripts/sync-posts.js
```

输出示例：
```
🚀 开始全量同步文章...

📝 发现 12 篇文章

处理: Koa为什么是洋葱圈模型... ✓ 已更新
处理: Mobx的智慧... ✓ 已更新
...

============================================================
✅ 同步完成！
   成功: 12 (创建: 0, 更新: 12)
   失败: 0
============================================================
```

#### 2. 同步单个文章

```bash
# 使用 npm script
pnpm sync:post "文章slug"

# 或直接运行脚本
node scripts/sync-posts.js "文章slug"
```

示例：
```bash
pnpm sync:post "【干货】滚动翻页通用方案（RxJS助力版）"
pnpm sync:post "Koa为什么是洋葱圈模型"
```

输出示例：
```
🚀 开始同步文章: 【干货】滚动翻页通用方案（RxJS助力版）

============================================================
✅ 同步成功！
   文章: 【干货】滚动翻页通用方案（RxJS助力版）
   操作: 已更新
============================================================
```

#### 3. 查看帮助

```bash
node scripts/sync-posts.js --help
```

### 文章格式要求

文章必须包含以下 frontmatter 字段：

```markdown
---
title: 文章标题          # 必需
date: 2026-01-22        # 必需
description: 文章描述   # 可选
tags:                   # 可选
  - React
  - TypeScript
---

文章内容...
```

### 常见场景

#### 场景 1: 新增文章后同步

```bash
# 编辑或创建新文章
vim content/post/新文章.md

# 同步到数据库
pnpm sync:post "新文章"
```

#### 场景 2: 修改文章后更新

```bash
# 修改文章内容
vim content/post/【干货】滚动翻页通用方案（RxJS助力版）.md

# 同步更新到数据库
pnpm sync:post "【干货】滚动翻页通用方案（RxJS助力版）"
```

#### 场景 3: 批量更新所有文章

```bash
# 修改了多篇文章后，全量同步
pnpm sync:all
```

### 错误处理

脚本会自动处理以下情况：

- ❌ 文章文件不存在 → 报错并退出
- ❌ 缺少必需字段（title/date）→ 报错并跳过
- ✅ 文章已存在 → 自动更新
- ✅ 文章不存在 → 自动创建

### 注意事项

1. **环境变量**：确保 `.env.local` 中配置了 `DATABASE_URL`
2. **Slug 匹配**：slug 必须与文件/目录名完全一致（包括中文、特殊字符）
3. **日期格式**：date 字段支持任何 JavaScript `Date` 可解析的格式
4. **并发执行**：全量同步是串行执行，避免数据库并发问题

### 开发技巧

**在开发时使用文件系统，发布前同步到数据库：**

```bash
# 1. 开发：直接编辑 markdown 文件
vim content/post/文章.md

# 2. 测试：在本地查看（从文件读取）
pnpm dev

# 3. 发布：同步到数据库
pnpm sync:post "文章"

# 4. 部署：推送到 Vercel
git push
```

### 其他数据库脚本

```bash
# 推送数据库结构
pnpm db:push

# 打开 Prisma Studio（可视化管理）
pnpm db:studio
```
